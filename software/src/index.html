<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <link rel="stylesheet" type="text/css" href="simcir.css" />
    <link rel="stylesheet" type="text/css" href="simcir-basicset.css" />
  <link rel="stylesheet" href="jquery-ui.css">
  <title>SimcirHW</title>
  </head>
  <body>
  <div id="tabs">
    <ul>
      <li><a href="#tabs-1">Circuito</a></li>
      <li><a href="#tabs-2">Mapeamento de pinos</a></li>
      <li id="link_tab_monitor"><a href="#tabs-3">Monitor de execução</a></li>
    </ul>
    <div id="tabs-1">
        <div id="mySimcir"></div>
        <div>
          <button id="getDataBtn">v get data v</button>
          <button id="setDataBtn">^ set data ^</button>
          <button id="validateBtn">validate</button>
        </div>
        <textarea id="dataArea" style="width:600px; height:200px;"></textarea>
    </div>
    <div id="tabs-2">
      <select id="boardSelector">
        <option>selecione uma placa</option>
        <option value="NodeMCU_ESP32S">NodeMCU ESP-32S WiFi ESP32</option>
        <option value="NodeMCU_V2">NodeMCU ESP-12 WiFi ESP8266</option>
        <option value="Wemos_D1">WeMos D1 R1 Wifi ESP8266</option>
      </select>
      <div id="boardArea" style="display:inline-block;margin-top:20px;"></div>
      <button id="sendBtn">send ckt</button>
    </div>
    <div id="tabs-3">
      <button id="startRealtimeMonitor">start</button>
      <button id="stopRealtimeMonitor">stop</button>
      <div id="chartsContainer"></div>
    </div>
  </div>
    
    
  <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
  <script type="text/javascript" src="jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="lang/ptbr.js"></script>
  <script type="text/javascript" src="circuit-parser.js"></script>
  <script type="text/javascript" src="simcir.js"></script>
  <script type="text/javascript" src="simcir-basicset.js"></script>
  <script type="text/javascript" src="misc/simcir-dso.js"></script>
  <script type="text/javascript" src="jquery-ui.js"></script>
  <script type="text/javascript" src="thirdpart/sweetalert.min.js"></script>
  <script type="text/javascript" src="thirdpart/mqtt.min.js"></script>
  <script type="text/javascript">

var circuitMessage = {};
var gpios = {};
var ws
$(function() {

  $("#tabs").tabs();

  var $s = simcir;

  var $simcir = $('#mySimcir');

  var getCircuitData = function() {
    return $s.controller(
        $simcir.find('.simcir-workspace') ).text();
  };
  var setCircuitData = function(data) {
    $s.setupSimcir($simcir, JSON.parse(data) );
  };

  // button click events
  $('#getDataBtn').click(function() {
    $('#dataArea').val(getCircuitData());
  });
  $('#setDataBtn').click(function() {
    setCircuitData($('#dataArea').val());
  });
  $('#validateBtn').click(function() {
    $s.controller(
      $simcir.find('.simcir-workspace') ).validate();
  });
  $('#sendBtn').click(function() {
    sendCircuit();
  });

  // load default (just specifies circuit size).
  setCircuitData('{ "width":600, "height":400 }');

  $('#boardSelector').change(function() {
    var HTMLboard = "";
    circuitMessage = $s.controller($simcir.find('.simcir-workspace')).getCircuitMessage();
    gpios = $.extend({},circuitMessage.messageToSend.circuit.inputs, circuitMessage.messageToSend.circuit.outputs);
    var HTMLoptions = '<option></option>';
    $.each(gpios, function(k, v) {
      HTMLoptions += '<option>' + k + '</option>';
    });
    switch ($(this).val()){
      case 'NodeMCU_ESP32S':
        HTMLboard += `
          <input type="hidden" name="board" value="NodeMCU_ESP32S" />
          <input type="hidden" name="hardware" value="esp32" />
          <div style="float:left;width:80px;text-align:right;margin-right:10px;">
            <select selectType="boardPin" name="VP" style="height:20.5px;margin-top:56px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="VN" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D34" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D35" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D32" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D33" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D25" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D26" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D27" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D14" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D12" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D13" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
          </div>
          `;
        HTMLboard += `<img src="img/NodeMCU_ESP32S.png" style="float:left;height:450px;"/>`;
        HTMLboard += `
          <div style="float:left;width:80px;margin-left:10px;">
            <select selectType="boardPin" name="D23" style="height:20.5px;margin-top:34.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D22" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="TX0" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="RX0" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D21" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D19" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D18" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D5"  style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="TX2" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="RX2" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D4"  style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D2"  style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D15" style="height:20.5px;margin-top:1.5px;width:80px">${HTMLoptions}</select>
          </div>
          `;
      break;
      case 'NodeMCU_V2':
        HTMLboard += `
          <input type="hidden" name="board" value="NodeMCU_V2" />
          <input type="hidden" name="hardware" value="esp8266" />
          <div style="float:left;width:80px;text-align:right;margin-right:10px;">
            <select selectType="boardPin" name="SD3" style="margin-top:138px;width:80px">${HTMLoptions}</select>
          </div>
          `;
        HTMLboard += `<img src="img/NodeMCU_V2.png" style="float:left;height:450px;"/>`;
        HTMLboard += `
          <div style="float:left;width:80px;margin-left:10px;">
            <select selectType="boardPin" name="D0" style="margin-top:47px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D1" style="margin-top:2px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D2" style="margin-top:2px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D3" style="margin-top:2px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D4" style="margin-top:2px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D5" style="margin-top:48px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D6" style="margin-top:2px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D7" style="margin-top:2px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D8" style="margin-top:2px;width:80px">${HTMLoptions}</select>
          </div>
          `;
      break;
      case 'Wemos_D1':
        HTMLboard += `<img src="img/Wemos_D1.png" style="float:left;height:500px;margin-left:100px"/>`;
        HTMLboard +=`
          <input type="hidden" name="board" value="Wemos_D1" />
          <input type="hidden" name="hardware" value="esp8266" />
          <div style="float:left;width:80px;margin-left:10px;">
            <select selectType="boardPin" name="D13" style="margin-top:200px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D12" style="margin-top:2px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D11" style="margin-top:2px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D10" style="margin-top:2px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D9" style="margin-top:2px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D8" style="margin-top:2px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D4" style="margin-top:42px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D3" style="margin-top:2px;width:80px">${HTMLoptions}</select>
            <select selectType="boardPin" name="D2" style="margin-top:2px;width:80px">${HTMLoptions}</select>
          </div>
          `;
      break;
      default:
        var HTMLboard = "";
      break;
    }
    $("#boardArea").html(HTMLboard);
  });


  var host = window.document.location.host.replace(/:.*/, '');

  ws = new WebSocket('ws://' + host + ':9062');
  var startMonitor = 0; var stopMonitor = 0;
  var monitorController = MonitorController();
  ws.onmessage = function (event) {
    console.log(event.data);
    var wsMessage = JSON.parse(event.data);
    if (wsMessage.type=="datalog") {
      if (startMonitor==0) {
        //updateMonitorData(wsMessage.data);
        monitorController.makeCharts(wsMessage.data);
        startMonitor = 1;
      } else if (stopMonitor==0){
        monitorController.updateMonitorData(wsMessage.data);
      }
    }
  };
  ws.onopen = function() {
    console.log('open ws connection');
  };

  function sendCircuit() {
    var arrOut = Object.keys(circuitMessage.messageToSend.circuit.outputs);
    var qtdOut = arrOut.length;
    var countOut = 0;
    var pinMap = {};
    $('select[selectType=boardPin]').each(function(i, el){
      // @TODO: validar se todos outputs foram mapeados e se não repetiu
      //if (arrOut.includes($(el).val())) {
      //	countOut++;
      //}
      if ($(el).val() != "") {
        pinMap[$(el).val()] = $(el).attr('name');
      }
    });
    
    circuitMessage.messageToSend.circuit["pin_map"] = pinMap;
    circuitMessage.messageToSend.circuit["hardware"] = $("input[name=hardware]").val();
    circuitMessage.messageToSend.circuit["board"] = $("input[name=board]").val();
    circuitMessage.messageToSend.circuit["cycles"] = 1;
    console.log(circuitMessage.messageToSend, JSON.stringify(circuitMessage.messageToSend));

    ws.send(JSON.stringify(circuitMessage.messageToSend));

    /*
    ws.send(`
    {
      "type":"circuit",
      "circuit":
      {
        "outputs":{
          "Out1":"(In1 AND NOT(In3)) OR (In2 AND In3)",
          "Out2":"In1 XOR In2"
        }
        ,"inputs":{
          "In1":1,
          "In2":0,
          "In3":{"values":[0,1,0,1],"timeslices":[1000,2000,1000,6000]}
        }
        ,"pin_map":{
          "Out1":"D0",
          "Out2":"D1"
        }
        ,"hardware":"esp8266"
        ,"board":"NodeMCU_V2"
        ,"cycles":1
      }
    }`);*/
  }



  
});

  </script>

  <script src="execution_monitor/monitor_script.js"></script>

  <style>
    #chartsContainer, [id^=chart_] {
      width: 100%;
      height: 200px;
    }
  </style>

  <script src="execution_monitor/amcharts.js"></script>
  <script src="execution_monitor/serial.js"></script>
  <script src="execution_monitor/light.js"></script>

  <script>
var updateMonitorControl;
$('#startRealtimeMonitor').click(function() {

  MonitorController().makeCharts();

});

var MonitorController = function() {

  let charts = [];

  function makeCharts(str) {
    let chartData = getChartData(str, true);
    $.each(chartData, (pinLabel, dataProvider) => {
      console.log("chart", pinLabel, dataProvider);
      $('#chartsContainer').append('<div id="chart_' + pinLabel + '"></div>');

      let chartConfig = {
        "type": "serial",
        "theme": "light",
        "dataProvider": dataProvider,
        "valueAxes": [{
          "position": "left",
          "title": pinLabel
        }],
        "graphs": [{
          "id": "g1",
          "fillAlphas": 0.4,
          "valueField": "value"
        }],
        "chartCursor": {
          "categoryBalloonDateFormat": "NN:S.QQQ",
          "cursorPosition": "mouse"
        },
        "categoryField": "date",
        "categoryAxis": {
          "minPeriod": "fff",
          "parseDates": true,
          "dateFormats": [{period: 'fff', format: 'S.QQQ'},
            {period: 'ss', format: 'S.QQQ'},
            {period: 'mm', format: 'NN:SS'},
            {period: 'hh', format: 'NN:SS'},
            {period: 'DD', format: 'SS:QQQ'},
            {period: 'WW', format: 'SS:QQQ'},
            {period: 'MM', format: 'SS:QQQ'},
            {period: 'YYYY', format: 'SS:QQQ'}]
        }
      };

      if (charts.length == 0) {
        chartConfig['chartScrollbar'] = {
          "offset": 30,
          "position": "top"
        };
      }

      charts.push(AmCharts.makeChart("chart_" + pinLabel, chartConfig));
    });

    for (let x in charts) {
      charts[x].addListener("zoomed", syncZoom);
      charts[x].addListener("init", addCursorListeners);
    }
  }

  function addCursorListeners(event) {
    event.chart.chartCursor.addListener("changed", handleCursorChange);
    event.chart.chartCursor.addListener("onHideCursor", handleHideCursor);
  }

  function syncZoom(event) {
    for (let x in charts) {
      if (charts[x].ignoreZoom) {
        charts[x].ignoreZoom = false;
      }
      if (event.chart != charts[x]) {
        charts[x].ignoreZoom = true;
        charts[x].zoomToDates(event.startDate, event.endDate);
      }
    }
  }

  function handleCursorChange(event) {
    for (let x in charts) {
      if (event.chart != charts[x]) {
        charts[x].chartCursor.syncWithCursor(event.chart.chartCursor);
      }
    }
  }

  function handleHideCursor() {
    for (let x in charts) {
      if (charts[x].chartCursor.hideCursor) {
        charts[x].chartCursor.forceShow = false;
        charts[x].chartCursor.hideCursor(false);
      }
    }
  }

  function updateMonitorData(str) {
    //console.log("asdas",charts);
    //monitorData = str;
    console.log(charts)
    let chartData = getChartData(str, false);
    let c = 0;
    $.each(chartData, (pinLabel, obj) => {
      //charts[c].dataProvider.push({date: obj[0].date, value: charts[c].dataProvider[charts[c].dataProvider.length-1].value});
      $.each(obj, (key, tobj) => {
        //console.log("DSA",this.charts[c].dataProvider[this.charts[c].dataProvider.length-1].ts,tobj.ts )
        //date.setDate(this.charts[c].dataProvider[this.charts[c].dataProvider.length-1].date.getMilliseconds() + tobj.date.getMilliseconds())
        charts[c].dataProvider.push({
          date: tobj.date,
          value: tobj.value
        });
      });
      charts[c].validateData();
      c++;
    });
  }

  let initime = 0;
  function getChartData(str, first) {

    //var objData = getTestData();
    let objData = str;
    let chartData = {};
    let firstDate = new Date(2000,1,2,0 ,0,0,0);

    $.each(gpios, function(pin, num) {
      chartData[pin] = [];
    });

    let pushPinData = function (pinLabel, pinValue, obj, newDate) {
      let dtemp = (chartData[pinLabel] && (chartData[pinLabel].length-1)>=0) ? 1 : 0;
      if (dtemp) {
        chartData[pinLabel].push({
          date: newDate,
          value: chartData[pinLabel][chartData[pinLabel].length-1].value
        });
      }
      chartData[pinLabel].push({
        date: newDate,
        value: pinValue || 0
      });
    };

    if (first) initime = objData[0].l;
    $.each(objData, function(k, obj) {
      let newDate = new Date(firstDate);
      newDate.setMilliseconds(newDate.getMilliseconds() + (obj.l - initime)/1000);
      let _t = $.extend({},obj['i'], obj['o']);
      console.log(_t)
      $.each(gpios, function(pinLabel) {
        pushPinData(pinLabel , _t[pinLabel], obj, newDate);
      });

    });
    console.log(chartData);
    return chartData;
  }
  return {
    makeCharts: makeCharts,
    updateMonitorData: updateMonitorData
  }
}



$('#stopRealtimeMonitor').click(function() {
  ws.send(JSON.stringify(
    {type: "datalog_stop"}
  ));
});

  function getTestData() {
    return JSON.parse(`
    [{
			"localtime": 160127839,
			"inputs": {
				"In2": 0,
				"In1": 0
			},
			"outputs": {
				"Out1": 0
			}
		}, {
			"localtime": 160220191,
			"inputs": {
				"In2": 0,
				"In1": 1
			},
			"outputs": {
				"Out1": 0
			}
		}, {
			"localtime": 160320854,
			"inputs": {
				"In2": 1,
				"In1": 0
			},
			"outputs": {
				"Out1": 0
			}
		}, {
			"localtime": 160421000,
			"inputs": {
				"In2": 1,
				"In1": 1
			},
			"outputs": {
				"Out1": 1
			}
		}, {
			"localtime": 160520686,
			"inputs": {
				"In2": 1,
				"In1": 1
			},
			"outputs": {
				"Out1": 1
			}
		}]`);
  }

  </script>

  <script>if (window.module) module = window.module;</script>
  </body>
</html>
